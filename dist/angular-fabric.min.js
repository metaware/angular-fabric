angular.module("common.fabric",["common.fabric.window","common.fabric.directive","common.fabric.canvas","common.fabric.dirtyStatus"]).factory("Fabric",["FabricWindow","$timeout","$window","FabricCanvas","FabricDirtyStatus",function(e,t,n,i,a){return function(n){function o(e){return"string"!=typeof e?"":e.charAt(0).toUpperCase()+e.slice(1)}function c(e,t){return t=t||f.getActiveObject(),"object"!=typeof t||null===t?"":t.getSelectionStyles&&t.isEditing?t.getSelectionStyles()[e]||"":t[e]||""}function r(e,t,n){if(n=n||f.getActiveObject(),n.setSelectionStyles&&n.isEditing){var i={};i[e]=t,n.setSelectionStyles(i)}else n[e]=t;v.render()}function l(e){var t=f.getActiveObject();return"object"==typeof t&&null!==t?t[e]:""}function s(e,t){var n=f.getActiveObject();n.set(e,t),v.render()}function u(e,t,n){t=t||"",n=n||512;for(var i=atob(e),a=[],o=0;o<i.length;o+=n){for(var c=i.slice(o,o+n),r=new Array(c.length),l=0;l<c.length;l++)r[l]=c.charCodeAt(l);var s=new Uint8Array(r);a.push(s)}var u=new Blob(a,{type:t});return u}function d(e){return/(^#[0-9A-F]{6}$)|(^#[0-9A-F]{3}$)/gi.test(e)}var f,g,v=angular.extend({canvasBackgroundColor:"#ffffff",canvasWidth:300,canvasHeight:300,canvasOriginalHeight:300,canvasOriginalWidth:300,maxContinuousRenderLoops:25,continuousRenderTimeDelay:500,editable:!0,JSONExportProperties:[],loading:!1,dirty:!1,initialized:!1,userHasClickedCanvas:!1,downloadMultipler:2,imageDefaults:{},textDefaults:{},shapeDefaults:{},windowDefaults:{transparentCorners:!1,rotatingPointOffset:25,padding:0},canvasDefaults:{selection:!1}},n);return v.renderCount=0,v.render=function(){var e=f.getObjects();for(var t in e)e[t].setCoords();f.calcOffset(),f.renderAll(),v.renderCount++,console.log("Render cycle:",v.renderCount)},v.setCanvas=function(e){f=e,f.selection=v.canvasDefaults.selection},v.setTextDefaults=function(e){v.textDefaults=e},v.setJSONExportProperties=function(e){v.JSONExportProperties=e},v.setCanvasBackgroundColor=function(e){v.canvasBackgroundColor=e,f.setBackgroundColor(e),v.render()},v.setCanvasWidth=function(e){v.canvasWidth=e,f.setWidth(e),v.render()},v.setCanvasHeight=function(e){v.canvasHeight=e,f.setHeight(e),v.render()},v.setCanvasSize=function(e,t){v.stopContinuousRendering();var n=v.canvasScale;v.resetZoom(),v.canvasWidth=e,v.canvasOriginalWidth=e,f.originalWidth=e,f.setWidth(e),v.canvasHeight=t,v.canvasOriginalHeight=t,f.originalHeight=t,f.setHeight(t),v.canvasScale=n,v.render(),v.setZoom(),v.render(),v.setZoom()},v.isLoading=function(){return v.isLoading},v.deactivateAll=function(){f.deactivateAll(),v.deselectActiveObject(),v.render()},v.clearCanvas=function(){f.clear(),f.setBackgroundColor("#ffffff"),v.render()},v.addObjectToCanvas=function(e){e.originalScaleX=e.scaleX,e.originalScaleY=e.scaleY,e.originalLeft=e.left,e.originalTop=e.top,f.add(e),v.setObjectZoom(e),f.setActiveObject(e),e.bringToFront(),v.center(),v.render()},v.addImage=function(e){fabric.Image.fromURL(e,function(e){e.id=v.createId();for(var t in v.imageOptions)e[t]=v.imageOptions[t];var n=new fabric.Image.filters.Tint({color:"#ffffff",opacity:0});e.filters.push(n),e.applyFilters(f.renderAll.bind(f)),v.addObjectToCanvas(e)},v.imageDefaults)},v.addShape=function(e){fabric.loadSVGFromURL(e,function(e){var t=fabric.util.groupSVGElements(e,v.shapeDefaults);t.id=v.createId();for(var n in v.shapeDefaults)t[n]=v.shapeDefaults[n];if(t.isSameColor&&t.isSameColor()||!t.paths)t.setFill("#0088cc");else if(t.paths)for(var i=0;i<t.paths.length;i++)t.paths[i].setFill("#0088cc");v.addObjectToCanvas(t)})},v.addText=function(t){t=t||"New Text";var n=new e.Text(t,v.textDefaults);n.id=v.createId(),v.addObjectToCanvas(n)},v.getText=function(){return l("text")},v.setText=function(e){s("text",e)},v.getFontSize=function(){return c("fontSize")},v.setFontSize=function(e){r("fontSize",parseInt(e,10)),v.render()},v.getTextAlign=function(){return o(l("textAlign"))},v.setTextAlign=function(e){s("textAlign",e.toLowerCase())},v.getFontFamily=function(){var e=l("fontFamily");return e?e.toLowerCase():""},v.setFontFamily=function(e){s("fontFamily",e.toLowerCase())},v.getLineHeight=function(){return c("lineHeight")},v.setLineHeight=function(e){r("lineHeight",parseFloat(e,10)),v.render()},v.isBold=function(){return"bold"===c("fontWeight")},v.toggleBold=function(){r("fontWeight","bold"===c("fontWeight")?"":"bold"),v.render()},v.isItalic=function(){return"italic"===c("fontStyle")},v.toggleItalic=function(){r("fontStyle","italic"===c("fontStyle")?"":"italic"),v.render()},v.isUnderline=function(){return c("textDecoration").indexOf("underline")>-1},v.toggleUnderline=function(){var e=v.isUnderline()?c("textDecoration").replace("underline",""):c("textDecoration")+" underline";r("textDecoration",e),v.render()},v.isLinethrough=function(){return c("textDecoration").indexOf("line-through")>-1},v.toggleLinethrough=function(){var e=v.isLinethrough()?c("textDecoration").replace("line-through",""):c("textDecoration")+" line-through";r("textDecoration",e),v.render()},v.getTextAlign=function(){return l("textAlign")},v.setTextAlign=function(e){s("textAlign",e)},v.getOpacity=function(){return c("opacity")},v.setOpacity=function(e){r("opacity",e)},v.getFlipX=function(){return l("flipX")},v.setFlipX=function(e){s("flipX",e)},v.toggleFlipX=function(){var e=v.getFlipX()?!1:!0;v.setFlipX(e),v.render()},v.center=function(){var e=f.getActiveObject();e&&(e.center(),v.updateActiveObjectOriginals(),v.render())},v.centerH=function(){var e=f.getActiveObject();e&&(e.centerH(),v.updateActiveObjectOriginals(),v.render())},v.centerV=function(){var e=f.getActiveObject();e&&(e.centerV(),v.updateActiveObjectOriginals(),v.render())},v.sendBackwards=function(){var e=f.getActiveObject();e&&(f.sendBackwards(e),v.render())},v.sendToBack=function(){var e=f.getActiveObject();e&&(f.sendToBack(e),v.render())},v.bringForward=function(){var e=f.getActiveObject();e&&(f.bringForward(e),v.render())},v.bringToFront=function(){var e=f.getActiveObject();e&&(f.bringToFront(e),v.render())},v.isTinted=function(){return l("isTinted")},v.toggleTint=function(){var e=f.getActiveObject();e.isTinted=!e.isTinted,e.filters[0].opacity=e.isTinted?1:0,e.applyFilters(f.renderAll.bind(f))},v.getTint=function(){var e=f.getActiveObject();return"object"!=typeof e||null===e?"":void 0!==e.filters&&void 0!==e.filters[0]?e.filters[0].color:void 0},v.setTint=function(e){if(d(e)){var t=f.getActiveObject();void 0!==t.filters&&void 0!==t.filters[0]&&(t.filters[0].color=e,t.applyFilters(f.renderAll.bind(f)))}},v.getFill=function(){return c("fill")},v.setFill=function(e){var t=f.getActiveObject();t&&("text"===t.type?r("fill",e):v.setFillPath(t,e))},v.setFillPath=function(e,t){if(e.isSameColor&&e.isSameColor()||!e.paths)e.setFill(t);else if(e.paths)for(var n=0;n<e.paths.length;n++)e.paths[n].setFill(t)},v.resetZoom=function(){v.canvasScale=1,v.setZoom()},v.setZoom=function(){var e=f.getObjects();for(var t in e)e[t].originalScaleX=e[t].originalScaleX?e[t].originalScaleX:e[t].scaleX,e[t].originalScaleY=e[t].originalScaleY?e[t].originalScaleY:e[t].scaleY,e[t].originalLeft=e[t].originalLeft?e[t].originalLeft:e[t].left,e[t].originalTop=e[t].originalTop?e[t].originalTop:e[t].top,v.setObjectZoom(e[t]);v.setCanvasZoom(),v.render()},v.setObjectZoom=function(e){var t=e.originalScaleX,n=e.originalScaleY,i=e.originalLeft,a=e.originalTop,o=t*v.canvasScale,c=n*v.canvasScale,r=i*v.canvasScale,l=a*v.canvasScale;e.scaleX=o,e.scaleY=c,e.left=r,e.top=l,e.setCoords()},v.setCanvasZoom=function(){var e=v.canvasOriginalWidth,t=v.canvasOriginalHeight,n=e*v.canvasScale,i=t*v.canvasScale;f.setWidth(n),f.setHeight(i)},v.updateActiveObjectOriginals=function(){var e=f.getActiveObject();e&&(e.originalScaleX=e.scaleX/v.canvasScale,e.originalScaleY=e.scaleY/v.canvasScale,e.originalLeft=e.left/v.canvasScale,e.originalTop=e.top/v.canvasScale)},v.toggleLockActiveObject=function(){var e=f.getActiveObject();e&&(e.lockMovementX=!e.lockMovementX,e.lockMovementY=!e.lockMovementY,e.lockScalingX=!e.lockScalingX,e.lockScalingY=!e.lockScalingY,e.lockUniScaling=!e.lockUniScaling,e.lockRotation=!e.lockRotation,e.lockObject=!e.lockObject,v.render())},v.selectActiveObject=function(){var e=f.getActiveObject();e&&(v.selectedObject=e,v.selectedObject.text=v.getText(),v.selectedObject.fontSize=v.getFontSize(),v.selectedObject.lineHeight=v.getLineHeight(),v.selectedObject.textAlign=v.getTextAlign(),v.selectedObject.opacity=v.getOpacity(),v.selectedObject.fontFamily=v.getFontFamily(),v.selectedObject.fill=v.getFill(),v.selectedObject.tint=v.getTint())},v.deselectActiveObject=function(){v.selectedObject=!1},v.deleteActiveObject=function(){var e=f.getActiveObject();f.remove(e),v.render()},v.isLoading=function(){return v.loading},v.setLoading=function(e){v.loading=e},v.setDirty=function(e){a.setDirty(e)},v.isDirty=function(){return a.isDirty()},v.setInitalized=function(e){v.initialized=e},v.isInitalized=function(){return v.initialized},v.getJSON=function(){var e=v.canvasScale;v.canvasScale=1,v.resetZoom();var t=JSON.stringify(f.toJSON(v.JSONExportProperties));return v.canvasScale=e,v.setZoom(),t},v.loadJSON=function(e){v.setLoading(!0),f.loadFromJSON(e,function(){t(function(){v.setLoading(!1),v.editable||v.disableEditing(),v.render()})})},v.getCanvasData=function(){var e=f.toDataURL({width:f.getWidth(),height:f.getHeight(),multiplier:v.downloadMultipler});return e},v.getCanvasBlob=function(){var e=v.getCanvasData(),t=e.replace("data:image/png;base64,",""),n=u(t,"image/png"),i=URL.createObjectURL(n);return i},v.download=function(e){v.deactivateAll();var t=v.canvasScale;v.resetZoom();var n=document.createElement("a"),i=e+".png";n.download=i,n.href=v.getCanvasBlob(),n.click(),v.canvasScale=t,v.setZoom()},v.continuousRenderCounter=0,v.continuousRenderHandle,v.stopContinuousRendering=function(){t.cancel(v.continuousRenderHandle),v.continuousRenderCounter=v.maxContinuousRenderLoops},v.startContinuousRendering=function(){v.continuousRenderCounter=0,v.continuousRender()},v.continuousRender=function(){v.userHasClickedCanvas||v.continuousRenderCounter>v.maxContinuousRenderLoops||(v.continuousRenderHandle=t(function(){v.setZoom(),v.render(),v.continuousRenderCounter++,v.continuousRender()},v.continuousRenderTimeDelay))},v.setUserHasClickedCanvas=function(e){v.userHasClickedCanvas=e},v.createId=function(){return Math.floor(1e4*Math.random())},v.disableEditing=function(){f.selection=!1,f.forEachObject(function(e){e.selectable=!1})},v.enableEditing=function(){f.selection=!0,f.forEachObject(function(e){e.selectable=!0})},v.setCanvasDefaults=function(){f.selection=v.canvasDefaults.selection},v.setWindowDefaults=function(){e.Object.prototype.transparentCorners=v.windowDefaults.transparentCorners,e.Object.prototype.rotatingPointOffset=v.windowDefaults.rotatingPointOffset,e.Object.prototype.padding=v.windowDefaults.padding},v.startCanvasListeners=function(){f.on("object:selected",function(){v.stopContinuousRendering(),t(function(){v.selectActiveObject(),v.setDirty(!0)})}),f.on("selection:created",function(){v.stopContinuousRendering()}),f.on("selection:cleared",function(){t(function(){v.deselectActiveObject()})}),f.on("after:render",function(){f.calcOffset()}),f.on("object:modified",function(){v.stopContinuousRendering(),t(function(){v.updateActiveObjectOriginals(),v.setDirty(!0)})})},v.init=function(){f=i.getCanvas(),v.canvasId=i.getCanvasId(),f.clear(),g=angular.fromJson(v.json),v.loadJSON(v.json),g=g||{},v.canvasScale=1,g.background=g.background||"#ffffff",v.setCanvasBackgroundColor(g.background),g.width=g.width||300,v.canvasOriginalWidth=g.width,g.height=g.height||300,v.canvasOriginalHeight=g.height,v.setCanvasSize(v.canvasOriginalWidth,v.canvasOriginalHeight),v.render(),v.setDirty(!1),v.setInitalized(!0),v.setCanvasDefaults(),v.setWindowDefaults(),v.startCanvasListeners(),v.startContinuousRendering(),a.startListening()},v.init(),v}}]);
angular.module("common.fabric.canvas",["common.fabric.window"]).service("FabricCanvas",["FabricWindow","$rootScope",function(a,n){function e(){return Math.floor(1e4*Math.random())}var c={canvasId:null,element:null,canvas:null};return c.setElement=function(a){c.element=a,n.$broadcast("canvas:element:selected")},c.createCanvas=function(){return c.canvasId="fabric-canvas-"+e(),c.element.attr("id",c.canvasId),c.canvas=new a.Canvas(c.canvasId),n.$broadcast("canvas:created"),c.canvas},c.getCanvas=function(){return c.canvas},c.getCanvasId=function(){return c.canvasId},c}]);
angular.module("common.fabric.constants",[]).service("FabricConstants",[function(){var e={rotatingPointOffset:20,padding:0,borderColor:"EEF6FC",cornerColor:"rgba(64, 159, 221, 1)",cornerSize:10,transparentCorners:!1,hasRotatingPoint:!0,centerTransform:!0};return{presetSizes:[{name:"Portrait (8.5 x 11)",height:1947,width:1510},{name:"Landscape (11 x 8.5)",width:1947,height:1510},{name:"Business Card (3.5 x 2)",height:368,width:630},{name:"Postcard (6 x 4)",height:718,width:1068},{name:"Content/Builder Product Thumbnail",height:400,width:760},{name:"Badge",height:400,width:400},{name:"Facebook Profile Picture",height:300,width:300},{name:"Facebook Cover Picture",height:315,width:851},{name:"Facebook Photo Post (Landscape)",height:504,width:403},{name:"Facebook Photo Post (Horizontal)",height:1008,width:806},{name:"Facebook Full-Width Photo Post",height:504,width:843}],fonts:[{name:"Arial"},{name:"Lora"},{name:"Croissant One"},{name:"Architects Daughter"},{name:"Emblema One"},{name:"Graduate"},{name:"Hammersmith One"},{name:"Oswald"},{name:"Oxygen"},{name:"Krona One"},{name:"Indie Flower"},{name:"Courgette"},{name:"Gruppo"},{name:"Ranchers"}],shapeCategories:[{name:"Popular Shapes",shapes:["arrow6","bubble4","circle1","rectangle1","star1","triangle1"]},{name:"Simple Shapes",shapes:["circle1","heart1","rectangle1","triangle1","star1","star2","star3","square1"]},{name:"Arrows & Pointers",shapes:["arrow1","arrow9","arrow3","arrow6"]},{name:"Bubbles & Balloons",shapes:["bubble5","bubble4"]},{name:"Check Marks",shapes:[]},{name:"Badges",shapes:["badge1","badge2","badge4","badge5","badge6"]}],JSONExportProperties:["height","width","background","objects","originalHeight","originalWidth","originalScaleX","originalScaleY","originalLeft","originalTop","lineHeight","lockMovementX","lockMovementY","lockScalingX","lockScalingY","lockUniScaling","lockRotation","lockObject","id","isTinted","filters"],shapeDefaults:angular.extend({fill:"#0088cc"},e),textDefaults:angular.extend({originX:"left",scaleX:1,scaleY:1,fontFamily:"Arial",fontSize:40,fill:"#454545",textAlign:"left"},e)}}]);
angular.module("common.fabric.directive",["common.fabric.canvas"]).directive("fabric",["$timeout","FabricCanvas","$window",function(e,t,c){return{scope:{fabric:"="},controller:function(e,c){t.setElement(c),t.createCanvas(),$("body").on("click","canvas",function(){e.fabric.setUserHasClickedCanvas&&e.fabric.setUserHasClickedCanvas(!0)}),e.$watch("fabric.canvasBackgroundColor",function(t){e.fabric.setCanvasBackgroundColor&&e.fabric.setCanvasBackgroundColor(t)}),e.$watch("fabric.selectedObject.text",function(t){"string"==typeof t&&(e.fabric.setText(t),e.fabric.render())}),e.$watch("fabric.selectedObject.fontSize",function(t){("string"==typeof t||"number"==typeof t)&&(e.fabric.setFontSize(t),e.fabric.render())}),e.$watch("fabric.selectedObject.lineHeight",function(t){("string"==typeof t||"number"==typeof t)&&(e.fabric.setLineHeight(t),e.fabric.render())}),e.$watch("fabric.selectedObject.textAlign",function(t){"string"==typeof t&&(e.fabric.setTextAlign(t),e.fabric.render())}),e.$watch("fabric.selectedObject.fontFamily",function(t){"string"==typeof t&&t&&(e.fabric.setFontFamily(t),e.fabric.render())}),e.$watch("fabric.selectedObject.opacity",function(t){("string"==typeof t||"number"==typeof t)&&(e.fabric.setOpacity(t),e.fabric.render())}),e.$watch("fabric.selectedObject.fill",function(t){"string"==typeof t&&(e.fabric.setFill(t),e.fabric.render())}),e.$watch("fabric.selectedObject.tint",function(t){"string"==typeof t&&(e.fabric.setTint(t),e.fabric.render())})}}}]);
angular.module("common.fabric.dirtyStatus",[]).service("FabricDirtyStatus",["$window",function(n){function o(){return t.isDirty()?"Oops! You have unsaved changes.\n\nPlease save before leaving so you don't lose any work.":void 0}var t={dirty:!1};return t.endListening=function(){n.onbeforeunload=null,n.onhashchange=null},t.startListening=function(){n.onbeforeunload=o,n.onhashchange=o},t.isDirty=function(){return t.dirty},t.setDirty=function(n){t.dirty=n},t}]);
angular.module("common.fabric.utilities",[]).directive("parentClick",["$timeout",function(n){return{scope:{parentClick:"&"},link:function(e,t){t.mousedown(function(){n(function(){e.parentClick()})}).children().mousedown(function(n){n.stopPropagation()})}}}]).factory("Keypress",[function(){var n={};return n.onSave=function(n){$(document).keydown(function(e){return(e.ctrlKey||e.metaKey)&&83===e.which?(e.preventDefault(),n(),!1):void 0})},n}]).filter("reverse",[function(){return function(n){return n?n.slice().reverse():void 0}}]);
angular.module("common.fabric.window",[]).factory("FabricWindow",["$window",function(n){return n.fabric}]);